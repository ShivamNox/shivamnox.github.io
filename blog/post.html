<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Post | shivamnox</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <div id="post"></div>
  <h3>Related Posts</h3>
  <div id="related-posts"></div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    async function loadPost() {
      const params = new URLSearchParams(location.search);
      const slug = params.get('slug');
      if (!slug) return;

      const res = await fetch(`../posts/${slug}.md`);
      const text = await res.text();
      const meta = extractFrontmatter(text);
      const content = text.split('---')[2]?.trim() || "";

      document.title = meta.title + " | shivamnox";
      document.getElementById('post').innerHTML = `
        <h1>${meta.title}</h1>
        <p class="meta">${meta.author} â€¢ ${formatDate(meta.date)}</p>
        <img src="${meta.image}" alt="${meta.title}" />
        <div class="content">${marked.parse(content)}</div>
        <p class="labels">${meta.labels.split(',').map(l => `<span>${l.trim()}</span>`).join(' ')}</p>
      `;

      loadRelated(meta.labels.split(',').map(l => l.trim()), slug);
    }

    async function loadRelated(labels, currentSlug) {
      const res = await fetch('../posts/index.json');
      const files = await res.json();
      const relatedContainer = document.getElementById('related-posts');
      
      for (const file of files) {
        if (file.replace('.md', '') === currentSlug) continue;
        const post = await fetch(`../posts/${file}`).then(r => r.text());
        const meta = extractFrontmatter(post);
        const postLabels = meta.labels.split(',').map(l => l.trim());
        if (labels.some(l => postLabels.includes(l))) {
          const el = document.createElement('div');
          el.className = 'related';
          el.innerHTML = `
            <a href="post.html?slug=${file.replace('.md','')}">
              <img src="${meta.image}" alt="${meta.title}" />
              <h4>${meta.title}</h4>
            </a>`;
          relatedContainer.appendChild(el);
        }
      }
    }

    function extractFrontmatter(md) {
      const match = md.match(/^---\n([\s\S]*?)\n---/);
      const fm = {};
      if (match) {
        match[1].split('\n').forEach(line => {
          const [key, ...rest] = line.split(':');
          fm[key.trim()] = rest.join(':').trim();
        });
      }
      return fm;
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
    }

    loadPost();
  </script>
</body>
</html>
