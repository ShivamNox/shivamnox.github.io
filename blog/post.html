<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Post | shivamnox</title>
<style>
body { font-family: system-ui, sans-serif; max-width: 800px; margin: auto; padding: 1rem; line-height: 1.6; }
img { width: 100%; border-radius: 8px; }
.meta { color: gray; font-size: 0.9em; margin-bottom: 0.5rem; }
.labels span {
  background: #eee;
  padding: 3px 8px;
  margin-right: 5px;
  border-radius: 5px;
  font-size: 0.8em;
}
.related { display: flex; flex-wrap: wrap; gap: 1rem; margin-top: 2rem; }
.related div { width: calc(50% - 0.5rem); }
.related img { width: 100%; border-radius: 5px; }
</style>
</head>
<body>
<div id="post"></div>
<h3>Related Posts</h3>
<div id="related"></div>

<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<script>
async function init() {
  const slug = new URLSearchParams(location.search).get('slug');
  if (!slug) return;
  const html = await fetch(`../posts/${slug}.html`).then(r => r.text());
  const meta = extractFrontmatter(html);
  const md = extractMarkdown(html);

  document.title = meta.title + " | shivamnox";
  document.getElementById('post').innerHTML = `
    <h1>${meta.title}</h1>
    <p class="meta">${meta.author} â€¢ ${formatDate(meta.date)}</p>
    <img src="${meta.image}" alt="${meta.title}">
    <div>${marked.parse(md)}</div>
    <p class="labels">${meta.labels.split(',').map(l=>`<span>${l.trim()}</span>`).join(' ')}</p>
  `;

  loadRelated(meta.labels.split(',').map(l=>l.trim()), slug);
}

async function loadRelated(labels, currentSlug) {
  const res = await fetch('../posts/index.json');
  const files = await res.json();
  const container = document.getElementById('related');
  for (const file of files) {
    const slug = file.replace('.html','');
    if (slug === currentSlug) continue;
    const html = await fetch(`../posts/${file}`).then(r => r.text());
    const meta = extractFrontmatter(html);
    const postLabels = meta.labels.split(',').map(l=>l.trim());
    if (labels.some(l => postLabels.includes(l))) {
      const el = document.createElement('div');
      el.innerHTML = `
        <a href="post.html?slug=${slug}">
          <img src="${meta.image}" alt="${meta.title}">
          <h4>${meta.title}</h4>
        </a>`;
      container.appendChild(el);
    }
  }
}

function extractFrontmatter(txt) {
  const match = txt.match(/^---([\s\S]*?)---/);
  const fm = {};
  if (match) match[1].trim().split('\n').forEach(line=>{
    const [k, ...v] = line.split(':');
    fm[k.trim()] = v.join(':').trim();
  });
  return fm;
}

function extractMarkdown(txt) {
  const m = txt.match(/<script type="text\/markdown">([\s\S]*?)<\/script>/);
  return m ? m[1].trim() : '';
}

function formatDate(d) {
  return new Date(d).toLocaleDateString('en-US',{year:'numeric',month:'long',day:'numeric'});
}

init();
</script>
</body>
</html>
