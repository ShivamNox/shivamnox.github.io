<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>My Blog | shivamnox</title>
  <link rel="stylesheet" href="../assets/style.css" />
</head>
<body>
  <h1>My Blog</h1>
  <div id="posts-container"></div>
  <button id="load-more" style="display:none;">Load More</button>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script>
    const POSTS_PER_PAGE = 10;
    let allPosts = [];
    let currentPage = 1;

    async function loadPosts() {
      const res = await fetch('../posts/index.json');
      const postFiles = await res.json();
      allPosts = postFiles.reverse(); // newest first
      renderPosts();
    }

    async function renderPosts() {
      const start = (currentPage - 1) * POSTS_PER_PAGE;
      const end = currentPage * POSTS_PER_PAGE;
      const slice = allPosts.slice(start, end);
      const container = document.getElementById('posts-container');

      for (const file of slice) {
        const post = await fetch(`../posts/${file}`).then(r => r.text());
        const meta = extractFrontmatter(post);
        const content = post.split('---')[2]?.trim() || "";
        const excerpt = content.split('\n').slice(0, 3).join(' ');

        const el = document.createElement('div');
        el.className = 'post-card';
        el.innerHTML = `
          <img src="${meta.image}" alt="${meta.title}" />
          <h2><a href="post.html?slug=${file.replace('.md','')}">${meta.title}</a></h2>
          <p class="meta">${meta.author} â€¢ ${formatDate(meta.date)}</p>
          <p>${excerpt}</p>
          <p class="labels">${meta.labels.split(',').map(l => `<span>${l.trim()}</span>`).join(' ')}</p>
        `;
        container.appendChild(el);
      }

      const loadMoreBtn = document.getElementById('load-more');
      if (end < allPosts.length) {
        loadMoreBtn.style.display = 'block';
        loadMoreBtn.onclick = () => {
          currentPage++;
          renderPosts();
        };
      } else {
        loadMoreBtn.style.display = 'none';
      }
    }

    function extractFrontmatter(md) {
      const match = md.match(/^---\n([\s\S]*?)\n---/);
      const fm = {};
      if (match) {
        match[1].split('\n').forEach(line => {
          const [key, ...rest] = line.split(':');
          fm[key.trim()] = rest.join(':').trim();
        });
      }
      return fm;
    }

    function formatDate(d) {
      return new Date(d).toLocaleDateString('en-US', {year:'numeric', month:'long', day:'numeric'});
    }

    loadPosts();
  </script>
</body>
</html>
